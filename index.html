<!DOCTYPE html>
<html lang="zh-TW" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Nio 分帳記帳本</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
      body { font-family: "Segoe UI", Microsoft JhengHei, sans-serif; background-color: #09090b; color: #e4e4e7; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #18181b; }
      ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
      .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
      .fade-enter-from, .fade-leave-to { opacity: 0; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      html, body { font-size: 14px; }
    </style>
  </head>
  <body>
    <div id="app" class="min-h-screen pb-20 bg-zinc-950 text-zinc-200">
      
      <transition name="fade">
        <div v-if="isInitializing" class="fixed inset-0 z-[9999] bg-zinc-950 flex flex-col items-center justify-center">
          <i class="fa-solid fa-wallet fa-spin text-5xl text-zinc-500 mb-4"></i>
          <p class="text-zinc-500 text-sm tracking-widest uppercase font-bold">Syncing Data...</p>
        </div>
      </transition>

      <nav class="bg-zinc-900 border-b border-zinc-800 sticky top-0 z-40 shadow-sm">
        <div class="px-4 h-14 flex justify-between items-center max-w-[1200px] mx-auto">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-zinc-200 border border-zinc-700">
              <i class="fa-solid fa-comments-dollar text-sm"></i>
            </div>
            <h1 class="font-bold text-lg text-white tracking-wide">記帳本</h1>
            <span v-if="isSaving" class="text-xs text-emerald-500 flex items-center font-mono ml-2">
              <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Saving...
            </span>
          </div>
          <div class="flex gap-2">
            <button @click="openBatchModal()" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-200 px-3 py-1.5 rounded text-sm font-bold transition flex items-center gap-1.5 border border-zinc-700">
              <i class="fa-solid fa-layer-group text-xs"></i> <span class="hidden sm:inline">團購</span>
            </button>
            <button @click="openModal()" class="bg-zinc-100 hover:bg-white text-black px-4 py-1.5 rounded text-sm font-bold transition flex items-center gap-1.5 shadow hover:shadow-md">
              <i class="fa-solid fa-plus"></i> 記一筆
            </button>
          </div>
        </div>

        <div class="bg-zinc-950 border-b border-zinc-800">
          <div class="max-w-[1200px] mx-auto px-4 py-2 flex items-center justify-between gap-3">
            
            <div class="flex items-center gap-2 flex-1 overflow-hidden">
              <label class="text-xs font-medium text-zinc-500 whitespace-nowrap hidden sm:inline">目前分頁:</label>
              <div class="relative flex-1 sm:flex-none">
                <select
                  v-model="currentSheetName"
                  @change="handleSheetChange()"
                  class="appearance-none bg-zinc-900 text-white text-sm border border-zinc-700 rounded px-3 pr-8 py-1 outline-none focus:border-emerald-500 w-full sm:w-48 cursor-pointer hover:bg-zinc-800 transition"
                >
                  <option v-for="name in sheetList" :key="name" :value="name">
                    {{ name }}
                  </option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-zinc-500">
                  <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
              </div>
              <button
                @click="refreshAll()"
                class="text-zinc-400 hover:text-white p-1.5 rounded hover:bg-zinc-800 transition"
                title="重新讀取"
              >
                <i class="fa-solid fa-rotate-right"></i>
              </button>
            </div>

            <div class="flex items-center gap-2">
              <button
                @click="createNewSheet"
                class="text-zinc-400 hover:text-emerald-400 p-1.5 rounded hover:bg-zinc-800 transition"
                title="新增分頁"
              >
                <i class="fa-solid fa-folder-plus text-base"></i>
              </button>
              <button
                @click="deleteCurrentSheet"
                class="text-zinc-400 hover:text-rose-400 p-1.5 rounded hover:bg-zinc-800 transition"
                title="刪除目前分頁"
              >
                <i class="fa-solid fa-trash-can text-base"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="px-2 overflow-x-auto no-scrollbar border-b border-zinc-800 bg-zinc-900/95 backdrop-blur-sm">
          <div class="flex gap-2 py-2 max-w-[1200px] mx-auto px-4">
            <button 
              v-for="tab in personTabs" 
              :key="tab"
              @click="activeTab = tab"
              :class="activeTab === tab ? 'bg-zinc-100 text-black shadow-sm' : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700 border border-zinc-700'"
              class="px-4 py-1 rounded-full text-sm font-bold whitespace-nowrap transition-all duration-200"
            >
              {{ tab }}
            </button>
          </div>
        </div>
      </nav>

      <div class="max-w-[1200px] mx-auto px-4 mt-4">
        <div class="grid grid-cols-2 gap-0 border border-zinc-800 rounded-lg overflow-hidden bg-zinc-900 divide-x divide-zinc-800">
          <div class="p-3 flex flex-col items-center sm:items-start">
            <div class="text-xs text-zinc-500 uppercase font-bold mb-1">應付 (Pay)</div>
            <div class="text-lg sm:text-xl font-mono font-bold text-rose-400">${{ formatNumber(summary.totalMyPay) }}</div>
          </div>
          <div class="p-3 flex flex-col items-center sm:items-start">
            <div class="text-xs text-zinc-500 uppercase font-bold mb-1">應收 (Receive)</div>
            <div class="text-lg sm:text-xl font-mono font-bold text-emerald-400">${{ formatNumber(summary.totalMyReceive) }}</div>
          </div>
        </div>
      </div>

      <div class="max-w-[1200px] mx-auto px-4 mt-4 pb-10">
        <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-xs font-bold text-zinc-500 uppercase tracking-wider border-b border-zinc-800 mb-2">
          <div class="col-span-2">日期 / 付款人</div>
          <div class="col-span-4">項目 / 分類</div>
          <div class="col-span-3">分攤對象</div>
          <div class="col-span-3 text-right">金額 / 我的帳務</div>
        </div>

        <div v-if="filteredItems.length === 0" class="text-center py-12 text-zinc-600 border border-dashed border-zinc-800 rounded-lg">
          <i class="fa-regular fa-folder-open text-3xl mb-2 opacity-50"></i>
          <p class="text-sm font-medium">沒有相關紀錄</p>
        </div>

        <div class="space-y-2">
          <div v-for="item in filteredItems" :key="item.id" class="group bg-zinc-900 hover:bg-zinc-800/80 border border-zinc-800 rounded-lg transition-colors duration-150 relative overflow-hidden">
            <div class="absolute left-0 top-0 bottom-0 w-1" :class="item.payer === 'Nio' ? 'bg-emerald-500' : 'bg-rose-500'"></div>

            <div class="p-3 pl-4 pr-16 md:pr-3 grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 items-center">
              <div class="md:col-span-2 flex md:flex-col justify-start gap-3 items-center md:items-start">
                <div class="text-zinc-400 font-mono text-sm">{{ item.date }}</div>
                <div class="flex items-center gap-2 md:mt-1">
                  <span class="text-sm font-bold text-zinc-300 bg-zinc-800 px-2 py-0.5 rounded border border-zinc-700">{{ item.payer }}</span>
                  <span class="text-xs text-zinc-500 md:hidden">先付</span>
                </div>
              </div>

              <div class="md:col-span-4">
                <div class="flex items-center gap-2 mb-1 md:mb-0">
                  <span class="text-base font-bold text-white truncate">{{ item.item }}</span>
                  <span class="text-xs text-zinc-500 border border-zinc-700 px-1.5 rounded bg-zinc-800/50">{{ item.category }}</span>
                </div>
                <div class="text-xs text-zinc-500 truncate" v-if="item.note">{{ item.note }}</div>
              </div>

              <div class="md:col-span-3">
                <div class="flex flex-wrap gap-1.5">
                  <span v-for="p in item.sharedWith" :key="p" 
                    class="text-xs px-2 py-0.5 rounded border flex items-center gap-1 transition-colors"
                    :class="item.paidBy && item.paidBy.includes(p) ? 'bg-emerald-900/30 text-emerald-400 border-emerald-900/50' : 'bg-zinc-950 text-zinc-400 border-zinc-700'"
                  >
                    {{ p }}
                    <i v-if="item.paidBy && item.paidBy.includes(p)" class="fa-solid fa-check text-[10px]"></i>
                  </span>
                </div>
              </div>

              <div class="md:col-span-3 flex justify-between md:flex-col md:items-end items-center border-t border-zinc-800/50 pt-2 mt-1 md:border-0 md:pt-0 md:mt-0">
                <div class="flex flex-col md:items-end">
                  <div class="text-lg font-bold text-white font-mono tracking-tight">${{ formatNumber(item.amount) }}</div>
                  <div class="text-xs text-zinc-600">{{ item.paymentMethod }}</div>
                </div>
                <div class="md:mt-1">
                  <div v-if="item.myPay > 0" class="text-rose-400 font-bold text-sm bg-rose-950/30 px-2 py-0.5 rounded border border-rose-900/50">
                    <span class="text-xs text-rose-500/70 mr-1 font-normal">我付</span>${{ formatNumber(item.myPay) }}
                  </div>
                  <div v-else-if="item.myReceive > 0" class="text-emerald-400 font-bold text-sm bg-emerald-950/30 px-2 py-0.5 rounded border border-emerald-900/50">
                    <span class="text-xs text-emerald-500/70 mr-1 font-normal">單收</span>${{ formatNumber(item.myReceive) }}
                  </div>
                  <div v-else class="text-zinc-600 text-xs italic pr-1">無關</div>
                </div>
              </div>
            </div>

            <div class="absolute top-2 right-2 flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
              <button @click.stop="editItem(item)" class="w-8 h-8 rounded bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white flex items-center justify-center border border-zinc-700 shadow-md">
                <i class="fa-solid fa-pen text-xs"></i>
              </button>
              <button @click.stop="deleteItem(item.id)" class="w-8 h-8 rounded bg-zinc-800 hover:bg-red-900/30 text-zinc-400 hover:text-red-400 flex items-center justify-center border border-zinc-700 shadow-md">
                <i class="fa-solid fa-trash text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <transition name="fade">
        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4">
          <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" @click="closeModal()"></div>
          <div class="bg-zinc-900 w-full max-w-md rounded-t-xl sm:rounded-xl border border-zinc-800 shadow-2xl relative z-10 max-h-[95vh] overflow-y-auto">
            <div class="sticky top-0 bg-zinc-900/95 backdrop-blur border-b border-zinc-800 px-4 py-3 flex justify-between items-center z-20">
              <h3 class="font-bold text-lg text-white">{{ isEditing ? '編輯帳務' : '新增帳務' }}</h3>
              <div class="flex items-center gap-3">
                 <button v-if="isEditing" @click="deleteItem(form.id)" class="text-rose-500 hover:text-rose-400 text-xs flex items-center gap-1 px-2 py-1 rounded hover:bg-rose-950/30"><i class="fa-solid fa-trash"></i> 刪除</button>
                 <button @click="closeModal()" class="w-8 h-8 rounded bg-zinc-800 text-zinc-400 hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-xmark text-sm"></i></button>
              </div>
            </div>
            <form @submit.prevent="saveItem" class="p-5 space-y-4">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">日期</label>
                  <input v-model="form.date" type="date" required class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none [color-scheme:dark]">
                </div>
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">金額</label>
                  <input v-model.number="form.amount" type="number" required class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none font-mono font-bold tracking-wide">
                </div>
              </div>
              <div>
                <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">項目名稱</label>
                <input v-model="form.item" type="text" required class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none">
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">付款人</label>
                  <div class="relative">
                    <select v-model="form.payer" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none appearance-none cursor-pointer">
                      <option v-for="p in peopleList" :value="p">{{ p }}</option>
                    </select>
                    <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-zinc-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">分類</label>
                  <div class="relative">
                    <select v-model="form.category" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none appearance-none cursor-pointer">
                      <option v-for="c in categoryList" :value="c">{{ c }}</option>
                    </select>
                    <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-zinc-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                  </div>
                </div>
              </div>
              <div class="bg-zinc-950/50 p-3 rounded border border-zinc-800/50">
                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase">分攤對象 <span class="text-zinc-600 font-normal normal-case">(每人 ${{ Math.round(form.amount / (form.sharedWith.length || 1)) }})</span></label>
                <div class="flex flex-wrap gap-2">
                  <div v-for="p in peopleList" :key="p" @click="toggleShared(p)" class="px-3 py-1.5 rounded text-sm font-bold cursor-pointer border transition select-none flex items-center gap-1" :class="form.sharedWith.includes(p) ? 'bg-zinc-100 text-black border-white' : 'bg-zinc-800 text-zinc-500 border-zinc-700 hover:border-zinc-500'">
                    {{ p }} <i v-if="form.sharedWith.includes(p)" class="fa-solid fa-check text-xs"></i>
                  </div>
                </div>
              </div>
              <div class="bg-zinc-950/50 p-3 rounded border border-zinc-800/50">
                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase">已還款</label>
                <div class="flex flex-wrap gap-2">
                  <div v-for="p in peopleList" :key="'paid-'+p" @click="togglePaidBy(p)" class="px-3 py-1.5 rounded text-sm font-bold cursor-pointer border transition select-none flex items-center gap-1" :class="form.paidBy.includes(p) ? 'bg-emerald-600 text-white border-emerald-500' : 'bg-zinc-800 text-zinc-500 border-zinc-700 hover:border-zinc-500'">
                    {{ p }} <i v-if="form.paidBy.includes(p)" class="fa-solid fa-check text-xs"></i>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-1 gap-3">
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">付款方式</label>
                  <div class="relative">
                    <select v-model="form.paymentMethod" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none appearance-none cursor-pointer">
                      <option v-for="b in bankList" :value="b">{{ b }}</option>
                    </select>
                    <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-zinc-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">備註</label>
                  <textarea v-model="form.note" rows="1" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none placeholder-zinc-600" placeholder="選填..."></textarea>
                </div>
              </div>
              <div class="pt-2">
                <button type="submit" class="w-full bg-white hover:bg-zinc-200 text-black py-3 rounded-lg font-bold text-base transition shadow-lg transform active:scale-[0.99]">
                  {{ isEditing ? '儲存修改' : '新增紀錄' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="showBatchModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4">
          <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" @click="closeBatchModal()"></div>
          <div class="bg-zinc-900 w-full max-w-3xl rounded-t-xl sm:rounded-xl border border-zinc-800 shadow-2xl relative z-10 max-h-[95vh] flex flex-col">
            <div class="sticky top-0 bg-zinc-900/95 backdrop-blur border-b border-zinc-800 px-4 py-3 flex justify-between items-center z-20 shrink-0">
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-emerald-400"></i>
                <h3 class="font-bold text-lg text-white">團購分帳模式</h3>
              </div>
              <button @click="closeBatchModal()" class="w-8 h-8 rounded bg-zinc-800 text-zinc-400 hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-xmark text-sm"></i></button>
            </div>
            <div class="overflow-y-auto p-5 space-y-6">
              <div class="bg-zinc-950/50 p-4 rounded-xl border border-zinc-800/50 space-y-3">
                <div class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-2">統一設定</div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <div class="col-span-2 sm:col-span-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">日期</label>
                    <input v-model="batchForm.date" type="date" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none [color-scheme:dark]">
                  </div>
                  <div class="col-span-2 sm:col-span-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">分類</label>
                    <select v-model="batchForm.category" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                      <option v-for="c in categoryList" :value="c">{{ c }}</option>
                    </select>
                  </div>
                  <div class="col-span-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">付款人</label>
                    <select v-model="batchForm.payer" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                      <option v-for="p in peopleList" :value="p">{{ p }}</option>
                    </select>
                  </div>
                  <div class="col-span-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">付款方式</label>
                    <select v-model="batchForm.paymentMethod" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                      <option v-for="b in bankList" :value="b">{{ b }}</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="space-y-2">
                <div class="flex justify-between items-center px-1">
                  <div class="text-xs font-bold text-zinc-500 uppercase tracking-wider">消費明細</div>
                  <button @click="addBatchRow()" class="text-xs bg-emerald-900/30 text-emerald-400 border border-emerald-900/50 px-2 py-1 rounded hover:bg-emerald-900/50 transition">
                    <i class="fa-solid fa-plus mr-1"></i>新增一列
                  </button>
                </div>
                <div v-for="(item, index) in batchList" :key="index" class="bg-zinc-900 border border-zinc-800 p-3 rounded-lg relative group">
                  <div class="absolute right-0 top-0 bottom-0 w-10 flex items-center justify-center sm:hidden z-10">
                     <button @click="removeBatchRow(index)" class="text-zinc-600 hover:text-rose-500 w-full h-full flex items-center justify-center">
                        <i class="fa-solid fa-trash"></i>
                     </button>
                  </div>
                  <div class="grid grid-cols-12 gap-2 sm:gap-3 items-center pr-8 sm:pr-0">
                    <div class="col-span-8 sm:col-span-3">
                      <input v-model="item.name" type="text" placeholder="品項" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                    </div>
                    <div class="col-span-4 sm:col-span-2">
                      <input v-model.number="item.amount" type="number" placeholder="$" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm text-white font-mono focus:border-emerald-500 outline-none">
                    </div>
                    <div class="col-span-7 sm:col-span-3">
                      <input v-model="item.note" type="text" placeholder="備註 (選填)" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm text-zinc-400 focus:border-emerald-500 outline-none">
                    </div>
                    <div class="col-span-5 sm:col-span-3">
                      <select v-model="item.owner" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                        <option value="" disabled>是誰的?</option>
                        <option v-for="p in peopleList" :value="p">{{ p }}</option>
                      </select>
                    </div>
                    <div class="hidden sm:flex col-span-1 justify-center">
                      <button @click="removeBatchRow(index)" class="w-8 h-8 rounded hover:bg-rose-950/30 text-zinc-600 hover:text-rose-500 transition flex items-center justify-center">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="border-t border-zinc-800 bg-zinc-900/95 p-4 flex justify-between items-center shrink-0 rounded-b-xl">
              <div class="flex flex-col">
                <span class="text-xs text-zinc-500">總金額</span>
                <span class="text-xl font-bold font-mono text-white">${{ batchTotal }}</span>
              </div>
              <button @click="saveBatch()" class="bg-white hover:bg-zinc-200 text-black px-6 py-2.5 rounded-lg font-bold text-sm shadow-lg transform active:scale-[0.99] transition">
                儲存 {{ batchList.length }} 筆紀錄
              </button>
            </div>
          </div>
        </div>
      </transition>
    </div>

    <script>
      const { createApp, ref, computed, onMounted } = Vue;

      createApp({
        setup() {
          const getTodayDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
          };
          
          // ★★★ 請填入你的 Apps Script 網址 ★★★
          const API_URL = "https://script.google.com/macros/s/AKfycbw-0HUE3onUx_mMHa8JCEFkdXQAUArFBtu9EZFmk3qMQAqydnB5e-6CHGPbk0rFyYpbyA/exec";

          const items = ref([]);
          const searchQuery = ref("");
          const isLoading = ref(false);
          const isSaving = ref(false);
          const isInitializing = ref(true);
          const showModal = ref(false);
          const showBatchModal = ref(false);
          const isEditing = ref(false);
          const currentId = ref(null);

          // 分頁狀態
          const currentSheetName = ref("");
          const sheetList = ref([]);

          // 基礎設定
          const peopleList = ref([]);
          const categoryList = ref([]);
          const bankList = ref([]);
          
          const activeTab = ref("全部");

          const defaultForm = {
            id: null, item: "", 
            date: getTodayDate(), amount: 0, payer: "", sharedWith: [], paidBy: [],
            category: "", paymentMethod: "", note: ""
          };
          const form = ref({ ...defaultForm });

          const batchForm = ref({ date: getTodayDate(), payer: "", category: "", paymentMethod: "現金" });
          const batchList = ref([]); 

          // 取得密碼
          const getPassword = () => {
            let pwd = localStorage.getItem("nio_splitwise_secret");
            if (!pwd) {
              pwd = prompt("請輸入管理員密碼：");
              if (pwd) localStorage.setItem("nio_splitwise_secret", pwd);
            }
            return pwd;
          };

          // 通用的 API 發送函式
          const sendCommand = async (action, extraData = {}) => {
            const userPassword = getPassword();
            if (!userPassword) return false;

            isSaving.value = true;
            try {
              const payload = {
                auth: userPassword,
                action: action,
                sheetName: currentSheetName.value, 
                ...extraData,
              };

              const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload),
              });
              const result = await res.json();

              if (result.status === "error") {
                alert(result.message);
                if (result.message.includes("密碼"))
                  localStorage.removeItem("nio_splitwise_secret");
                return false;
              }
              return true;
            } catch (e) {
              alert("操作失敗，請檢查網路");
              return false;
            } finally {
              isSaving.value = false;
            }
          };

          // 1. 取得分頁列表
          const fetchSheetList = async () => {
            try {
              const res = await fetch(`${API_URL}?action=get_sheets`);
              const list = await res.json();
              if (Array.isArray(list)) {
                sheetList.value = list;
                if (!currentSheetName.value || !list.includes(currentSheetName.value)) {
                  if (list.length > 0) currentSheetName.value = list[0];
                }
              }
            } catch (e) { console.error("無法取得分頁清單", e); }
          };

          const fetchSettings = async () => {
            try {
              const res = await fetch(`${API_URL}?action=get_settings&sheet=${encodeURIComponent(currentSheetName.value)}`);
              const data = await res.json();
              if (data.people) peopleList.value = data.people;
              if (data.categories) categoryList.value = data.categories;
              if (data.banks) bankList.value = data.banks;
              
              if (peopleList.value.length > 0) {
                defaultForm.payer = peopleList.value[0];
                batchForm.value.payer = peopleList.value[0];
              }
              if (categoryList.value.length > 0) {
                defaultForm.category = categoryList.value[0];
                batchForm.value.category = categoryList.value[0];
              }
              if (bankList.value.length > 0) defaultForm.paymentMethod = bankList.value[0];
            } catch (e) { console.error("設定讀取失敗", e); }
          };

          // 2. 讀取特定分頁資料
          const fetchData = async () => {
            if (!currentSheetName.value) return;
            isLoading.value = true;
            items.value = [];
            try {
              const url = `${API_URL}?sheet=${encodeURIComponent(currentSheetName.value)}`;
              const res = await fetch(url);
              const data = await res.json();
              if (data.error) {
                console.warn(data.error);
                if (data.sheetList) sheetList.value = data.sheetList;
              } else {
                items.value = data; 
              }
            } catch (error) { alert("讀取失敗"); } finally { isLoading.value = false; }
          };

          const handleSheetChange = () => {
            isInitializing.value = true;
            fetchData();
            fetchSettings();
            setTimeout(() => isInitializing.value = false, 500);
          };

          const refreshAll = async () => {
             isInitializing.value = true;
             await fetchSheetList();
             await fetchData();
             await fetchSettings();
             isInitializing.value = false;
          };

          // 3. 儲存項目
          const saveItem = async () => {
            form.value.myPay = calcMyPay.value;
            form.value.myReceive = calcMyReceive.value;

            if (isEditing.value) {
              const idx = items.value.findIndex((i) => i.id === form.value.id);
              if (idx !== -1) items.value[idx] = { ...form.value };
            } else {
              items.value.unshift({ ...form.value, id: Date.now().toString() });
            }
            closeModal();
            const success = await sendCommand("save", { data: items.value });
            if(!success) fetchData(); 
          };

          // 4. 刪除項目
          const deleteItem = async (id) => {
            if (confirm("刪除此項目？")) {
              items.value = items.value.filter((i) => i.id !== id);
              closeModal(); 
              const success = await sendCommand("save", { data: items.value });
              if(!success) fetchData();
            }
          };

          // 5. 建立新分頁
          const createNewSheet = async () => {
            const newName = prompt("請輸入新分頁名稱 (例如: 2024-06)：");
            if (!newName) return;
            if (sheetList.value.includes(newName)) {
              alert("分頁已存在，直接切換");
              currentSheetName.value = newName;
              fetchData();
              return;
            }
            const success = await sendCommand("create_sheet", { sheetName: newName });
            if (success) {
              alert("分頁建立成功！");
              items.value = [];
              await fetchSheetList(); 
              currentSheetName.value = newName; 
            }
          };

          // 6. 刪除目前分頁
          const deleteCurrentSheet = async () => {
            if (sheetList.value.length <= 1) { alert("至少要保留一個分頁！"); return; }
            if (!confirm(`確定要刪除整個「${currentSheetName.value}」分頁嗎？\n此動作無法復原！`)) return;

            const success = await sendCommand("delete_sheet");
            if (success) {
              alert("分頁已刪除");
              await fetchSheetList(); 
              if (sheetList.value.length > 0) {
                currentSheetName.value = sheetList.value[0];
                fetchData();
              }
            }
          };
          
          // ★★★ 修正點：加入 closeBatchModal 定義 ★★★
          const closeModal = () => (showModal.value = false);
          const closeBatchModal = () => (showBatchModal.value = false);

          // 團購邏輯
          const openBatchModal = () => { 
            batchForm.value.date = getTodayDate();
            if(categoryList.value.length > 0) batchForm.value.category = categoryList.value[0];
            const defaultOwner = peopleList.value.length > 0 ? peopleList.value[0] : "";
            batchList.value = [
              { name: "", amount: null, owner: defaultOwner, note: "" },
              { name: "", amount: null, owner: defaultOwner, note: "" }
            ];
            showBatchModal.value = true; 
          };
          const addBatchRow = () => { 
             const defaultOwner = peopleList.value.length > 0 ? peopleList.value[0] : "";
             batchList.value.push({ name: "", amount: null, owner: defaultOwner, note: "" }); 
          };
          const removeBatchRow = (idx) => { if(batchList.value.length > 1) batchList.value.splice(idx, 1); };
          
          const saveBatch = async () => {
            const validItems = batchList.value.filter(i => i.name && i.amount && i.owner);
            if (validItems.length === 0) { alert("請至少輸入一筆完整的明細"); return; }
            
            const newRecords = validItems.map(detail => {
              let myPay = 0; let myReceive = 0;
              const isPayerMe = batchForm.value.payer === "Nio";
              const isOwnerMe = detail.owner === "Nio";
              if (isOwnerMe && !isPayerMe) myPay = detail.amount;
              if (isPayerMe && !isOwnerMe) myReceive = detail.amount;

              return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                date: batchForm.value.date,
                item: detail.name, 
                amount: detail.amount,
                payer: batchForm.value.payer,
                sharedWith: [detail.owner], 
                paidBy: [], 
                category: batchForm.value.category,
                paymentMethod: batchForm.value.paymentMethod,
                note: detail.note || "", 
                myPay: myPay,
                myReceive: myReceive
              };
            });
            
            items.value.unshift(...newRecords); 
            closeBatchModal();
            await sendCommand("save", { data: items.value });
          };

          // 計算邏輯
          const calcMyPay = computed(() => {
            if (!form.value.amount || form.value.sharedWith.length === 0) return 0;
            const unitPrice = Math.round(form.value.amount / form.value.sharedWith.length);
            if (form.value.sharedWith.includes("Nio") && form.value.payer === "Nio") return 0;
            if (form.value.sharedWith.includes("Nio") && form.value.payer !== "Nio") return unitPrice;
            return 0;
          });
          const calcMyReceive = computed(() => {
            if (!form.value.amount || form.value.sharedWith.length === 0) return 0;
            const unitPrice = Math.round(form.value.amount / form.value.sharedWith.length);
            if (form.value.payer === "Nio") return unitPrice;
            return 0;
          });
          const batchTotal = computed(() => batchList.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));
          const personTabs = computed(() => ["全部", ...peopleList.value]);
          
          const filteredItems = computed(() => {
            const validItems = items.value.filter(i => i.item && i.item.toString().trim() !== "");
            let list = validItems;
            if (activeTab.value !== "全部") {
               list = list.filter(i => i.payer === activeTab.value || i.sharedWith.includes(activeTab.value));
            }
            if (searchQuery.value) {
               const q = searchQuery.value.toLowerCase();
               list = list.filter(i => i.item.toLowerCase().includes(q) || (i.note && i.note.toLowerCase().includes(q)));
            }
            return list;
          });

          const summary = computed(() => {
            const list = filteredItems.value;
            const totalMyPay = list.reduce((sum, i) => sum + (Number(i.myPay) || 0), 0);
            const totalMyReceive = list.reduce((sum, i) => {
               if (i.payer === "Nio") return sum + (Number(i.myReceive) || 0);
               return sum;
            }, 0);
            return { totalMyPay, totalMyReceive };
          });
          
          const toggleShared = (name) => {
            const idx = form.value.sharedWith.indexOf(name);
            if (idx === -1) form.value.sharedWith.push(name);
            else form.value.sharedWith.splice(idx, 1);
          };
          const togglePaidBy = (name) => {
            if (!form.value.paidBy) form.value.paidBy = [];
            const idx = form.value.paidBy.indexOf(name);
            if (idx === -1) form.value.paidBy.push(name);
            else form.value.paidBy.splice(idx, 1);
          };
          const formatNumber = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

          const openModal = () => {
            isEditing.value = false;
            form.value = { 
                ...defaultForm, date: getTodayDate(), sharedWith: [], paidBy: [],
                payer: form.value.payer || (peopleList.value[0] || ""),
                category: form.value.category || (categoryList.value[0] || ""),
                paymentMethod: form.value.paymentMethod || (bankList.value[0] || "")
            }; 
            showModal.value = true;
          };
          const editItem = (item) => {
            isEditing.value = true;
            form.value = JSON.parse(JSON.stringify(item));
            if (!Array.isArray(form.value.paidBy)) form.value.paidBy = []; 
            showModal.value = true;
          };

          onMounted(async () => {
            isInitializing.value = true;
            await fetchSheetList(); 
            await Promise.all([ fetchSettings(), fetchData() ]);
            isInitializing.value = false;
          });

          return {
            items, searchQuery, isLoading, isSaving, isInitializing,
            showModal, showBatchModal, isEditing, form, batchForm, batchList, batchTotal,
            sheetList, currentSheetName, peopleList, categoryList, bankList, personTabs, activeTab,
            filteredItems, summary, 
            fetchData, handleSheetChange, createNewSheet, deleteCurrentSheet, refreshAll,
            openModal, openBatchModal, closeBatchModal, closeModal,
            saveItem, saveBatch, deleteItem, editItem,
            toggleShared, togglePaidBy, addBatchRow, removeBatchRow,
            formatNumber, calcMyPay, calcMyReceive,
            changeSheet, createNewSheet, deleteCurrentSheet
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>


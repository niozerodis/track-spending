<!DOCTYPE html>
<html lang="zh-TW" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Nio 分帳記帳本</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
      body { font-family: "Segoe UI", Microsoft JhengHei, sans-serif; background-color: #09090b; color: #e4e4e7; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #18181b; }
      ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
      .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
      .fade-enter-from, .fade-leave-to { opacity: 0; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      html, body { font-size: 14px; }
      /* 加入抓取游標樣式 */
      .cursor-grab { cursor: grab; }
      .cursor-grabbing { cursor: grabbing; }
    </style>
  </head>
  <body>
    <div id="app" class="min-h-screen pb-20 bg-zinc-950 text-zinc-200">
      
      <transition name="fade">
        <div v-if="isInitializing" class="fixed inset-0 z-[9999] bg-zinc-950 flex flex-col items-center justify-center">
          <i class="fa-solid fa-wallet fa-spin text-5xl text-zinc-500 mb-4"></i>
          <p class="text-zinc-500 text-sm tracking-widest uppercase font-bold">Syncing Data...</p>
        </div>
      </transition>

      <nav class="bg-zinc-900 border-b border-zinc-800 sticky top-0 z-40 shadow-sm">
        <div class="px-4 h-14 flex justify-between items-center max-w-[1200px] mx-auto">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-zinc-200 border border-zinc-700">
              <i class="fa-solid fa-comments-dollar text-sm"></i>
            </div>
            <h1 class="font-bold text-lg text-white tracking-wide">記帳本</h1>
            <span v-if="isSaving" class="text-xs text-emerald-500 flex items-center font-mono ml-2">
              <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Saving...
            </span>
            <div class="flex items-center gap-1">
              <div class="relative group">
                <select @change="changeSheet($event.target.value)" class="appearance-none bg-transparent font-bold text-lg text-white pr-6 cursor-pointer outline-none hover:text-emerald-400 transition">
                   <option v-for="s in sheetList" :key="s" :value="s" :selected="s === currentSheet" class="bg-zinc-900 text-zinc-200 text-sm">
                     {{ s }}
                   </option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pointer-events-none text-zinc-500 group-hover:text-emerald-400">
                   <i class="fa-solid fa-caret-down text-xs"></i>
                </div>
              </div>
              
              <button @click="createNewSheet()" class="w-6 h-6 rounded-full bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white flex items-center justify-center border border-zinc-700 transition ml-1" title="新增分頁">
                 <i class="fa-solid fa-plus text-[10px]"></i>
              </button>
            </div>
            <span v-if="isSaving" class="text-xs text-emerald-500 flex items-center font-mono ml-2">
              <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Saving...
            </span>
          </div>
        
          <div class="flex gap-2">
            <button @click="exportToExcel()" class="bg-emerald-800 hover:bg-emerald-700 text-zinc-200 w-9 h-9 rounded flex items-center justify-center border border-emerald-700 transition shadow-lg" title="匯出 Excel">
              <i class="fa-solid fa-file-csv text-sm"></i>
            </button>
            <button @click="openBatchModal()" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-200 px-3 py-1.5 rounded text-sm font-bold transition flex items-center gap-1.5 border border-zinc-700">
              <i class="fa-solid fa-layer-group text-xs"></i> <span class="hidden sm:inline">團購</span>分帳
            </button>
            <button @click="openModal()" class="bg-zinc-100 hover:bg-white text-black px-4 py-1.5 rounded text-sm font-bold transition flex items-center gap-1.5 shadow hover:shadow-md">
              <i class="fa-solid fa-plus"></i> 記一筆
            </button>
          </div>
        </div>

        <div class="border-t border-zinc-800 bg-zinc-900/95 backdrop-blur-sm">
          <div class="max-w-[1200px] mx-auto px-4 flex items-center justify-between gap-2">
            
            <div 
              ref="scrollContainer"
              @mousedown="startDrag"
              @mouseleave="stopDrag"
              @mouseup="stopDrag"
              @mousemove="doDrag"
              class="overflow-x-auto no-scrollbar flex gap-2 py-2 flex-1 cursor-grab active:cursor-grabbing select-none"
            >
              <button 
                v-for="tab in personTabs" 
                :key="tab"
                @click="activeTab = tab"
                :class="activeTab === tab ? 'bg-zinc-100 text-black shadow-sm' : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700 border border-zinc-700'"
                class="px-4 py-1 rounded text-sm font-bold whitespace-nowrap transition-all duration-200"
              >
                {{ tab }}
              </button>
            </div>

            <div class="shrink-0 py-2 pl-2 border-l border-zinc-800">
              <div class="relative">
                <select v-model="filterBank" class="w-32 bg-zinc-800 text-zinc-200 text-xs font-bold border border-zinc-700 rounded py-1.5 pl-2 pr-6 appearance-none focus:border-zinc-500 outline-none cursor-pointer">
                  <option v-for="b in bankFilterOptions" :value="b">{{ b }}</option>
                </select>
                <div class="absolute inset-y-0 right-2 flex items-center pointer-events-none text-zinc-500">
                  <i class="fa-solid fa-filter text-xs"></i>
                </div>
              </div>
            </div>

          </div>
        </div>
      </nav>

      <div class="max-w-[1200px] mx-auto px-4 mt-4">
        <div class="grid grid-cols-2 gap-0 border border-zinc-800 rounded-lg overflow-hidden bg-zinc-900 divide-x divide-zinc-800">
          <div class="p-3 flex flex-col items-center sm:items-start">
            <div class="text-xs text-zinc-500 uppercase font-bold mb-1">應付 (Pay)</div>
            <div class="text-lg sm:text-xl font-mono font-bold text-rose-400">${{ formatNumber(summary.totalMyPay) }}</div>
          </div>
          <div class="p-3 flex flex-col items-center sm:items-start">
            <div class="text-xs text-zinc-500 uppercase font-bold mb-1">應收 (Receive)</div>
            <div class="text-lg sm:text-xl font-mono font-bold text-emerald-400">${{ formatNumber(summary.totalMyReceive) }}</div>
          </div>
        </div>
      </div>

      <div class="max-w-[1200px] mx-auto px-4 mt-4 pb-10">
        <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-xs font-bold text-zinc-500 uppercase tracking-wider border-b border-zinc-800 mb-2">
          <div class="col-span-2 cursor-pointer select-none flex items-center gap-2 hover:text-zinc-300 transition" @click="toggleSort">
            日期 / 付款人
            <i class="fa-solid" :class="sortOrder === 'desc' ? 'fa-sort-down mb-1' : 'fa-sort-up mt-1'"></i>
          </div>
          <div class="col-span-4">項目 / 分類</div>
          <div class="col-span-3">分攤對象</div>
          <div class="col-span-3 text-right">金額 / 我的帳務</div>
        </div>

        <div v-if="filteredItems.length === 0" class="text-center py-12 text-zinc-600 border border-dashed border-zinc-800 rounded-lg">
          <i class="fa-regular fa-folder-open text-3xl mb-2 opacity-50"></i>
          <p class="text-sm font-medium">沒有相關紀錄</p>
        </div>

        <div class="space-y-2">
          <div v-for="item in filteredItems" :key="item.id" class="group bg-zinc-900 hover:bg-zinc-800/80 border border-zinc-800 rounded-lg transition-colors duration-150 relative overflow-hidden">
            <div class="absolute left-0 top-0 bottom-0 w-1" :class="item.payer === 'Nio' ? 'bg-emerald-500' : 'bg-rose-500'"></div>

            <div class="p-3 pl-4 pr-16 md:pr-3 grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 items-center">
              
              <div class="md:col-span-2 flex md:flex-col justify-start gap-3 items-center md:items-start">
                <div class="text-zinc-400 font-mono text-sm">{{ item.date }}</div>
                <div class="flex items-center gap-2 md:mt-1">
                  <span class="text-sm font-bold text-zinc-300 bg-zinc-800 px-2 py-0.5 rounded border border-zinc-700">{{ item.payer }}</span>
                  <span class="text-xs text-zinc-500 md:hidden">先付</span>
                </div>
              </div>

              <div class="md:col-span-4">
                <div class="flex items-center gap-2 mb-1 md:mb-0">
                  <span class="text-base font-bold text-white truncate">{{ item.item }}</span>
                  <span class="text-xs text-zinc-500 border border-zinc-700 px-1.5 rounded">{{ item.category }}</span>
                </div>
                <div class="text-xs text-zinc-500 truncate" v-if="item.note">{{ item.note }}</div>
              </div>

              <div class="md:col-span-3">
                <div class="flex flex-wrap gap-1.5">
                  <span v-for="p in item.sharedWith" :key="p" 
                    class="text-xs px-2 py-0.5 rounded border flex items-center gap-1 transition-colors"
                    :class="item.paidBy && item.paidBy.includes(p) ? 'bg-emerald-900/30 text-emerald-400 border-emerald-900/50' : 'bg-zinc-950 text-zinc-400 border-zinc-700'"
                  >
                    {{ p }}
                    <i v-if="item.paidBy && item.paidBy.includes(p)" class="fa-solid fa-check text-[10px]"></i>
                  </span>
                </div>
              </div>

              <div class="md:col-span-3 flex justify-between md:flex-col md:items-end items-center border-t border-zinc-800/50 pt-2 mt-1 md:border-0 md:pt-0 md:mt-0">
                <div class="flex flex-col md:items-end">
                  <div class="text-lg font-bold text-white font-mono tracking-tight">${{ formatNumber(item.amount) }}</div>
                  <div class="text-xs text-zinc-600">{{ item.paymentMethod }}</div>
                </div>
                
                <div class="md:mt-1">
                  
                  <template v-if="activeTab === '全部' || activeTab === 'Nio'">
                    <div v-if="item.myReceive > 0" class="text-emerald-400 font-bold text-sm bg-emerald-950/30 px-2 py-0.5 rounded border border-emerald-900/50 mb-1 md:mb-0">
                      <span class="text-xs text-emerald-500/70 mr-1 font-normal">單收</span>${{ formatNumber(item.myReceive) }}
                    </div>
                    <div v-if="item.myPay > 0" class="text-rose-400 font-bold text-sm bg-rose-950/30 px-2 py-0.5 rounded border border-rose-900/50">
                      <span class="text-xs text-rose-500/70 mr-1 font-normal">我付</span>${{ formatNumber(item.myPay) }}
                    </div>
                    <div v-if="item.myReceive === 0 && item.myPay === 0" class="text-zinc-600 text-xs italic pr-1">無關</div>
                  </template>
              
                  <template v-else>
                    <div v-if="item.payer === 'Nio' && item.sharedWith.includes(activeTab)" class="text-emerald-400 font-bold text-sm bg-emerald-950/30 px-2 py-0.5 rounded border border-emerald-900/50">
                      <span class="text-xs text-emerald-500/70 mr-1 font-normal">單收</span>${{ formatNumber(Math.round(item.amount / item.sharedWith.length)) }}
                    </div>
              
                    <div v-else-if="item.payer === activeTab && item.sharedWith.includes('Nio')" class="text-rose-400 font-bold text-sm bg-rose-950/30 px-2 py-0.5 rounded border border-rose-900/50">
                      <span class="text-xs text-rose-500/70 mr-1 font-normal">我付</span>${{ formatNumber(Math.round(item.amount / item.sharedWith.length)) }}
                    </div>
                    
                    <div v-else class="text-zinc-600 text-xs italic pr-1">無關</div>
                  </template>
              
                </div>
              </div>
            </div>

            <div class="absolute top-2 right-2 flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
              <button @click.stop="editItem(item)" class="w-8 h-8 rounded bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white flex items-center justify-center border border-zinc-700 shadow-md">
                <i class="fa-solid fa-pen text-xs"></i>
              </button>
              <button @click.stop="deleteItem(item.id)" class="w-8 h-8 rounded bg-zinc-800 hover:bg-red-900/30 text-zinc-400 hover:text-red-400 flex items-center justify-center border border-zinc-700 shadow-md">
                <i class="fa-solid fa-trash text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <transition name="fade">
        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4">
          <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" @click="closeModal()"></div>
          <div class="bg-zinc-900 w-full max-w-md rounded-t-xl sm:rounded-xl border border-zinc-800 shadow-2xl relative z-10 max-h-[95vh] overflow-y-auto">
            <div class="sticky top-0 bg-zinc-900/95 backdrop-blur border-b border-zinc-800 px-4 py-3 flex justify-between items-center z-20">
              <h3 class="font-bold text-lg text-white">{{ isEditing ? '編輯帳務' : '新增帳務' }}</h3>
              <div class="flex items-center gap-3">
                 <button v-if="isEditing" @click="deleteItem(form.id)" class="text-rose-500 hover:text-rose-400 text-xs flex items-center gap-1 px-2 py-1 rounded hover:bg-rose-950/30"><i class="fa-solid fa-trash"></i> 刪除</button>
                 <button @click="closeModal()" class="w-8 h-8 rounded bg-zinc-800 text-zinc-400 hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-xmark text-sm"></i></button>
              </div>
            </div>
            
            <form @submit.prevent="saveItem" class="p-5 space-y-4">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">日期</label>
                  <input v-model="form.date" type="date" required class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none [color-scheme:dark]">
                </div>
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">金額</label>
                  <input v-model.number="form.amount" type="number" required class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none font-mono font-bold tracking-wide">
                </div>
              </div>

              <div>
                <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">項目名稱</label>
                <input v-model="form.item" type="text" required class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none">
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">付款人</label>
                  <div class="relative">
                    <select v-model="form.payer" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none appearance-none cursor-pointer">
                      <option v-for="p in payerList" :value="p">{{ p }}</option>
                    </select>
                    <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-zinc-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">分類</label>
                  <div class="relative">
                    <select v-model="form.category" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none appearance-none cursor-pointer">
                      <option v-for="c in categoryList" :value="c">{{ c }}</option>
                    </select>
                    <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-zinc-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                  </div>
                </div>
              </div>

              <div class="bg-zinc-950/50 p-3 rounded border border-zinc-800/50">
                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase">分攤對象 <span class="text-zinc-600 font-normal normal-case">(每人 ${{ Math.round(form.amount / (form.sharedWith.length || 1)) }})</span></label>
                <div class="flex flex-wrap gap-2">
                  <div v-for="p in memberList" :key="p" @click="toggleShared(p)" class="px-3 py-1.5 rounded text-sm font-bold cursor-pointer border transition select-none flex items-center gap-1" :class="form.sharedWith.includes(p) ? 'bg-zinc-100 text-black border-white' : 'bg-zinc-800 text-zinc-500 border-zinc-700 hover:border-zinc-500'">
                    {{ p }} <i v-if="form.sharedWith.includes(p)" class="fa-solid fa-check text-xs"></i>
                  </div>
                </div>
              </div>

              <div class="bg-zinc-950/50 p-3 rounded border border-zinc-800/50">
                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase">已還款</label>
                <div class="flex flex-wrap gap-2">
                  <div v-for="p in memberList" :key="'paid-'+p" @click="togglePaidBy(p)" class="px-3 py-1.5 rounded text-sm font-bold cursor-pointer border transition select-none flex items-center gap-1" :class="form.paidBy.includes(p) ? 'bg-emerald-600 text-white border-emerald-500' : 'bg-zinc-800 text-zinc-500 border-zinc-700 hover:border-zinc-500'">
                    {{ p }} <i v-if="form.paidBy.includes(p)" class="fa-solid fa-check text-xs"></i>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 gap-3">
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">付款方式</label>
                  <div class="relative">
                    <select v-model="form.paymentMethod" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none appearance-none cursor-pointer">
                      <option v-for="b in bankList" :value="b">{{ b }}</option>
                    </select>
                    <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-zinc-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-bold text-zinc-500 mb-1 uppercase">備註</label>
                  <textarea v-model="form.note" rows="1" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-base text-white focus:border-zinc-500 outline-none" placeholder="選填..."></textarea>
                </div>
              </div>

              <div class="pt-2">
                <button type="submit" class="w-full bg-white hover:bg-zinc-200 text-black py-3 rounded-lg font-bold text-base transition shadow-lg transform active:scale-[0.99]">
                  {{ isEditing ? '儲存修改' : '新增紀錄' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="showBatchModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4">
          <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" @click="closeBatchModal()"></div>
          <div class="bg-zinc-900 w-full max-w-3xl rounded-t-xl sm:rounded-xl border border-zinc-800 shadow-2xl relative z-10 max-h-[95vh] flex flex-col">
            
            <div class="sticky top-0 bg-zinc-900/95 backdrop-blur border-b border-zinc-800 px-4 py-3 flex justify-between items-center z-20 shrink-0">
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-emerald-400"></i>
                <h3 class="font-bold text-lg text-white">團購分帳模式</h3>
              </div>
              <button @click="closeBatchModal()" class="w-8 h-8 rounded bg-zinc-800 text-zinc-400 hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-xmark text-sm"></i></button>
            </div>

            <div class="overflow-y-auto p-5 space-y-6">
              
              <div class="bg-zinc-950/50 p-4 rounded-xl border border-zinc-800/50 space-y-3">
                <div class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-2">統一設定</div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <div class="col-span-2 sm:col-span-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">日期</label>
                    <input v-model="batchForm.date" type="date" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none [color-scheme:dark]">
                  </div>
                  <div class="col-span-2 sm:col-span-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">分類</label>
                    <select v-model="batchForm.category" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                      <option v-for="c in categoryList" :value="c">{{ c }}</option>
                    </select>
                  </div>
                  <div class="col-span-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">付款人</label>
                    <select v-model="batchForm.payer" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                      <option v-for="p in payerList" :value="p">{{ p }}</option>
                    </select>
                  </div>
                  <div class="col-span-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">付款方式</label>
                    <select v-model="batchForm.paymentMethod" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                      <option v-for="b in bankList" :value="b">{{ b }}</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="space-y-2">
                <div class="flex justify-between items-center px-1">
                  <div class="text-xs font-bold text-zinc-500 uppercase tracking-wider">消費明細</div>
                  <button @click="addBatchRow()" class="text-xs bg-emerald-900/30 text-emerald-400 border border-emerald-900/50 px-2 py-1 rounded hover:bg-emerald-900/50 transition">
                    <i class="fa-solid fa-plus mr-1"></i>新增一列
                  </button>
                </div>

                <div v-for="(item, index) in batchList" :key="index" class="bg-zinc-900 border border-zinc-800 p-3 rounded-lg relative group">
                  
                  <button @click="removeBatchRow(index)" class="absolute right-2 top-1/2 -translate-y-1/2 text-zinc-600 hover:text-rose-500 sm:hidden z-10 w-8 h-8 flex items-center justify-center">
                    <i class="fa-solid fa-trash"></i>
                  </button>

                  <div class="grid grid-cols-12 gap-2 sm:gap-3 items-center pr-8 sm:pr-0">
                    
                    <div class="col-span-8 sm:col-span-3">
                      <input v-model="item.name" type="text" placeholder="品項" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                    </div>
                    
                    <div class="col-span-4 sm:col-span-2">
                      <input v-model.number="item.amount" type="number" placeholder="$" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm text-white font-mono focus:border-emerald-500 outline-none">
                    </div>

                    <div class="col-span-7 sm:col-span-3">
                      <input v-model="item.note" type="text" placeholder="備註 (選填)" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm text-zinc-400 focus:border-emerald-500 outline-none">
                    </div>

                    <div class="col-span-5 sm:col-span-3">
                      <select v-model="item.owner" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none">
                        <option v-for="p in memberList" :value="p">{{ p }}</option>
                      </select>
                    </div>

                    <div class="hidden sm:flex col-span-1 justify-center">
                      <button @click="removeBatchRow(index)" class="w-8 h-8 rounded hover:bg-rose-950/30 text-zinc-600 hover:text-rose-500 transition flex items-center justify-center">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            <div class="border-t border-zinc-800 bg-zinc-900/95 p-4 flex justify-between items-center shrink-0 rounded-b-xl">
              <div class="flex flex-col">
                <span class="text-xs text-zinc-500">總金額</span>
                <span class="text-xl font-bold font-mono text-white">${{ batchTotal }}</span>
              </div>
              <button @click="saveBatch()" class="bg-white hover:bg-zinc-200 text-black px-6 py-2.5 rounded-lg font-bold text-sm shadow-lg transform active:scale-[0.99] transition">
                儲存 {{ batchList.length }} 筆紀錄
              </button>
            </div>

          </div>
        </div>
      </transition>

    </div>

    <script>
      const { createApp, ref, computed, onMounted } = Vue;

      createApp({
        setup() {
          const sortOrder = ref('desc');
          const toggleSort = () => {
            sortOrder.value = sortOrder.value === 'desc' ? 'asc' : 'desc';
          };

          const filterBank = ref("全部");
          const bankFilterOptions = computed(() => ["全部", ...bankList.value]);

          // === 拖曳滾動相關邏輯 ===
          const scrollContainer = ref(null);
          const isDragging = ref(false);
          const startX = ref(0);
          const scrollLeft = ref(0);

          const startDrag = (e) => {
            isDragging.value = true;
            startX.value = e.pageX - scrollContainer.value.offsetLeft;
            scrollLeft.value = scrollContainer.value.scrollLeft;
          };

          const stopDrag = () => {
            isDragging.value = false;
          };

          const doDrag = (e) => {
            if (!isDragging.value) return;
            e.preventDefault(); // 防止選取文字
            const x = e.pageX - scrollContainer.value.offsetLeft;
            const walk = (x - startX.value) * 2; // 數字越大捲動越快
            scrollContainer.value.scrollLeft = scrollLeft.value - walk;
          };
          // ======================

          const filteredItems = computed(() => {
            let list = items.value.filter(i => i.item && i.item.toString().trim() !== "");
            
            if (activeTab.value !== "全部") {
              list = list.filter(i => i.payer === activeTab.value || i.sharedWith.includes(activeTab.value));
            }

            if (filterBank.value !== "全部") {
              list = list.filter(i => i.paymentMethod === filterBank.value);
            }
           
            return list.sort((a, b) => {
              const dateA = new Date(a.date).getTime();
              const dateB = new Date(b.date).getTime();
              
              if (dateA === dateB) {
                  const idA = String(a.id);
                  const idB = String(b.id);
                  return sortOrder.value === 'desc' ? idB.localeCompare(idA) : idA.localeCompare(idB);
              }

              if (sortOrder.value === 'desc') {
                return dateB - dateA;
              } else {
                return dateA - dateB;
              }
            });
          });

          const getTodayDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
          };
          
          const API_URL = "https://script.google.com/macros/s/AKfycbw-0HUE3onUx_mMHa8JCEFkdXQAUArFBtu9EZFmk3qMQAqydnB5e-6CHGPbk0rFyYpbyA/exec";

          // 分別定義兩個名單
          const payerList = ref([]);
          const memberList = ref([]);
          const categoryList = ref([]);
          const bankList = ref([]);

          const items = ref([]);
          const isInitializing = ref(true);
          const isLoading = ref(false);
          const isSaving = ref(false);
          const showModal = ref(false);
          const showBatchModal = ref(false); 
          const isEditing = ref(false);
          const activeTab = ref("全部");

          const defaultForm = {
            id: null, item: "", 
            date: getTodayDate(), amount: 0, payer: "", sharedWith: [], paidBy: [],
            category: "", paymentMethod: "", note: ""
          };
          const form = ref({ ...defaultForm });

          const batchForm = ref({
            date: getTodayDate(),
            payer: "",
            category: "", 
            paymentMethod: "現金"
          });
          const batchList = ref([]); 

          const getPassword = () => {
            const STORAGE_KEY = "nio_splitwise_secret";
            let pwd = localStorage.getItem(STORAGE_KEY);
            if (!pwd) {
              pwd = prompt("請輸入管理員密碼：");
              if (pwd) localStorage.setItem(STORAGE_KEY, pwd);
            }
            return pwd;
          };

          const calcMyPay = computed(() => {
            if (!form.value.amount || form.value.sharedWith.length === 0) return 0;
            const unitPrice = Math.round(form.value.amount / form.value.sharedWith.length);
            if (form.value.sharedWith.includes("Nio")) {
              return unitPrice;
            }
            return 0;
          });

          const calcMyReceive = computed(() => {
            if (!form.value.amount || form.value.sharedWith.length === 0) return 0;
            if (form.value.payer === "Nio") {
               let receivable = form.value.amount;
               if (form.value.sharedWith.includes("Nio")) {
                  const unitPrice = Math.round(form.value.amount / form.value.sharedWith.length);
                  receivable -= unitPrice;
               }
               return receivable > 0 ? receivable : 0;
            }
            return 0;
          });

          const batchTotal = computed(() => {
            return batchList.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
          });

          // 頁籤通常使用「分攤名單」比較完整 (包含所有可能出現的人)
          const personTabs = computed(() => ["全部", ...memberList.value]);

          // === 修改後的 Summary 計算邏輯 ===
          const summary = computed(() => {
            const list = filteredItems.value;
            let totalMyPay = 0;
            let totalMyReceive = 0;

            // 情況 A: 「全部」或「Nio」分頁 (顯示全域帳務：我的總支出 & 總應收)
            // 這邊維持原本邏輯：Pay = 我該付的錢(含幫自己付), Receive = 別人欠我的總數
            if (activeTab.value === "全部" || activeTab.value === "Nio") {
               totalMyPay = list.reduce((sum, i) => sum + (Number(i.myPay) || 0), 0);
               totalMyReceive = list.reduce((sum, i) => {
                  if (i.payer === "Nio") return sum + (Number(i.myReceive) || 0);
                  return sum;
               }, 0);
            } 
            // 情況 B: 「特定朋友」分頁 (只計算我跟 "這個人" 的債務關係)
            else {
               const targetPerson = activeTab.value;
               
               list.forEach(item => {
                  // 計算單價 (無條件四捨五入，跟畫面顯示保持一致)
                  const unitPrice = Math.round(item.amount / (item.sharedWith.length || 1));

                  // 1. 應付 (Pay): 這個人付錢，且分攤名單有我 -> 我欠他錢
                  if (item.payer === targetPerson && item.sharedWith.includes("Nio")) {
                     totalMyPay += unitPrice;
                  }

                  // 2. 應收 (Receive): 我付錢，且分攤名單有他 -> 他欠我錢
                  if (item.payer === "Nio" && item.sharedWith.includes(targetPerson)) {
                     totalMyReceive += unitPrice;
                  }
               });
            }

            return { totalMyPay, totalMyReceive };
          });

          const toggleShared = (name) => {
            const idx = form.value.sharedWith.indexOf(name);
            if (idx === -1) form.value.sharedWith.push(name);
            else form.value.sharedWith.splice(idx, 1);
          };

          const togglePaidBy = (name) => {
            if (!form.value.paidBy) form.value.paidBy = [];
            const idx = form.value.paidBy.indexOf(name);
            if (idx === -1) form.value.paidBy.push(name);
            else form.value.paidBy.splice(idx, 1);
          };

          // === 新增：分頁管理變數 ===
          const sheetList = ref([]);
          const currentSheet = ref(""); // 目前選中的分頁名稱

          // 修改 fetchSettings：讀取後端回傳的分頁清單
          const fetchSettings = async () => {
            try {
              // 呼叫設定時，也要傳目前的 sheetName (如果有)，雖然讀設定跟 sheet 關係不大，但保持習慣
              const res = await fetch(`${API_URL}?action=get_settings&sheetName=${currentSheet.value}`);
              const data = await res.json();
              
              if (data.sheets) {
                 sheetList.value = data.sheets;
                 // 如果目前沒有選定分頁，預設選第一個
                 if (!currentSheet.value && sheetList.value.length > 0) {
                    currentSheet.value = sheetList.value[0];
                 }
              }
              
              if (data.payers) payerList.value = data.payers;
              if (data.members) memberList.value = data.members;
              if (data.categories) categoryList.value = data.categories;
              if (data.banks) bankList.value = data.banks;
              
              // 設定預設值
              if (payerList.value.length > 0) {
                defaultForm.payer = payerList.value[0];
                batchForm.value.payer = payerList.value[0];
              }
              if (categoryList.value.length > 0) {
                defaultForm.category = categoryList.value[0];
                batchForm.value.category = categoryList.value[0]; 
              }
              if (bankList.value.length > 0) defaultForm.paymentMethod = bankList.value[0];
            } catch (e) { console.error("設定讀取失敗", e); }
          };

          const fetchData = async () => {
            // 如果還沒決定 sheet，就先不讀取
            if (!currentSheet.value) return; 

            isLoading.value = true;
            try {
              // ★ 關鍵：傳送 sheetName 參數
              const res = await fetch(`${API_URL}?sheetName=${encodeURIComponent(currentSheet.value)}`);
              items.value = await res.json();
            } catch (e) { alert("讀取失敗，請檢查網路"); } finally { 
               isInitializing.value = false; 
               isLoading.value = false;
            }
          };

          const changeSheet = (newSheet) => {
             if (newSheet === currentSheet.value) return;
             currentSheet.value = newSheet;
             items.value = []; // 清空當前畫面
             isInitializing.value = true; // 顯示 Loading
             fetchData(); // 重新讀取該分頁資料
          };

          const createNewSheet = async () => {
             const name = prompt("請輸入新分頁名稱 (例如: 2026-02)：");
             if (!name) return;
             
             const userPassword = getPassword();
             if (!userPassword) return;

             isInitializing.value = true; // 顯示轉圈圈
             
             try {
                const payload = { 
                   auth: userPassword, 
                   action: "create_sheet", 
                   newSheetName: name,
                   sheetName: currentSheet.value // 傳當前的當作參考
                };
                
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                const result = await res.json();
                
                if (result.status === "success") {
                   alert("建立成功！");
                   sheetList.value = result.sheets; // 更新清單
                   currentSheet.value = name; // 自動切換到新分頁
                   items.value = []; // 新分頁應該是空的
                   fetchData();
                } else {
                   alert("建立失敗：" + (result.message || "未知錯誤"));
                   isInitializing.value = false;
                }
             } catch(e) {
                alert("建立請求失敗");
                isInitializing.value = false;
             }
          };

          const closeModal = () => { showModal.value = false; };
          
          const closeBatchModal = () => { showBatchModal.value = false; };
          
          const openBatchModal = () => { 
            batchForm.value.date = getTodayDate();
            if(categoryList.value.length > 0) batchForm.value.category = categoryList.value[0];
            
            // 預設擁有者使用 memberList
            const defaultOwner = memberList.value.length > 0 ? memberList.value[0] : "";
            batchList.value = [
              { name: "", amount: null, owner: defaultOwner, note: "" },
              { name: "", amount: null, owner: defaultOwner, note: "" }
            ];
            showBatchModal.value = true; 
          };

          const addBatchRow = () => { 
             const defaultOwner = memberList.value.length > 0 ? memberList.value[0] : "";
             batchList.value.push({ name: "", amount: null, owner: defaultOwner, note: "" }); 
          };
          
          const removeBatchRow = (idx) => { if(batchList.value.length > 1) batchList.value.splice(idx, 1); };
          
          const saveBatch = async () => {
            const validItems = batchList.value.filter(i => i.name && i.amount && i.owner);
            if (validItems.length === 0) { alert("請至少輸入一筆完整的明細"); return; }

            const userPassword = getPassword();
            if (!userPassword) return;

            const newRecords = validItems.map(detail => {
              let myPay = 0;
              let myReceive = 0;
              const isPayerMe = batchForm.value.payer === "Nio";
              const isOwnerMe = detail.owner === "Nio";

              if (isOwnerMe) myPay = detail.amount;
              if (isPayerMe && !isOwnerMe) myReceive = detail.amount;

              return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                date: batchForm.value.date,
                item: detail.name, 
                amount: detail.amount,
                payer: batchForm.value.payer,
                sharedWith: [detail.owner], 
                paidBy: [], 
                category: batchForm.value.category,
                paymentMethod: batchForm.value.paymentMethod,
                note: detail.note || "", 
                myPay: myPay,
                myReceive: myReceive
              };
            });

            isSaving.value = true;
            items.value.unshift(...newRecords); 
            closeBatchModal();

            try {
              const payload = { auth: userPassword, action: "save", data: items.value };
              const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
              const result = await res.json();
              if (result.status === "error" && result.message.includes("密碼")) {
                localStorage.removeItem("nio_splitwise_secret");
                alert("密碼錯誤，請重新操作");
                fetchData();
              }
            } catch (e) { alert("儲存失敗"); fetchData(); } finally { isSaving.value = false; }
          };

          const saveItem = async () => {
            const userPassword = getPassword();
            if (!userPassword) return;
            form.value.myPay = calcMyPay.value;
            form.value.myReceive = calcMyReceive.value;
            isSaving.value = true;
            try {
              const payload = { auth: userPassword, action: "save", data: isEditing.value ? items.value.map(i => i.id === form.value.id ? form.value : i) : [form.value, ...items.value], sheetName: currentSheet.value };
              if (isEditing.value) {
                const idx = items.value.findIndex(i => i.id === form.value.id);
                if (idx !== -1) items.value[idx] = { ...form.value };
              } else {
                form.value.id = Date.now().toString();
                items.value.unshift({ ...form.value });
              }
              closeModal();
              const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
              const result = await res.json();
              if (result.status === "error" && result.message && result.message.includes("密碼")) {
                localStorage.removeItem("nio_splitwise_secret");
                alert("密碼錯誤，請重新操作");
                fetchData();
              }
            } catch (e) { alert("儲存失敗"); fetchData(); } finally { isSaving.value = false; }
          };

          const openModal = () => {
            isEditing.value = false;
            form.value = { 
                ...defaultForm, 
                date: getTodayDate(), 
                sharedWith: [], paidBy: [],
                payer: form.value.payer || (payerList.value[0] || ""),
                category: form.value.category || (categoryList.value[0] || ""),
                paymentMethod: form.value.paymentMethod || (bankList.value[0] || "")
            }; 
            showModal.value = true;
          };

          const editItem = (item) => {
            isEditing.value = true;
            const data = JSON.parse(JSON.stringify(item));
            if (!Array.isArray(data.paidBy)) data.paidBy = []; 
            form.value = data;
            showModal.value = true;
          };

          const deleteItem = async (id) => {
            if (!confirm("確定刪除?")) return;
            const userPassword = getPassword();
            if (!userPassword) return;
            const originalItems = [...items.value];
            items.value = items.value.filter(i => i.id !== id);
            closeModal(); 
            isSaving.value = true;
            try {
              const payload = { auth: userPassword, action: "save", data: items.value };
              const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
              const result = await res.json();
              if (result.status === "error") {
                if (result.message.includes("密碼")) {
                  localStorage.removeItem("nio_splitwise_secret");
                  alert("密碼錯誤");
                }
                items.value = originalItems;
              }
            } catch (e) { alert("刪除失敗"); items.value = originalItems; } finally { isSaving.value = false; }
          };

          const formatNumber = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

          const exportToExcel = () => {
            const list = filteredItems.value;
            // 直接讀取我們剛剛修好的 summary 計算結果
            // 它已經會根據 Tab 是「全部」還是「特定人」自動給出正確的應付/應收數字
            const stats = summary.value; 

            if (list.length === 0) {
              alert("沒有資料可以匯出");
              return;
            }

            // \uFEFF 是 BOM，確保 Excel 開啟時中文不亂碼
            let csvContent = "\uFEFF"; 

            // === 第一部分：頂部統計資訊 ===
            // 這裡顯示的金額，完全對應網頁上方看到的紅色/綠色數字
            csvContent += `統計模式,${activeTab.value}\n`;
            csvContent += `總應收 (Receive),${stats.totalMyReceive}\n`;
            csvContent += `總應付 (Pay),${stats.totalMyPay}\n`;
            csvContent += `\n`; // 空一行分隔

            // === 第二部分：標題列 ===
            // 依照您的要求：日期、付款人、項目、分攤對象、單收的金額
            csvContent += "日期,付款人,項目,分攤對象,單收金額(每人)\n";

            // === 第三部分：詳細資料 ===
            list.forEach(item => {
              // 計算單收金額 (總額 / 人數)
              const unitPrice = Math.round(item.amount / (item.sharedWith.length || 1));
              
              // 處理文字中的逗號 (CSV 格式需求)
              const escape = (txt) => txt ? `"${txt.toString().replace(/"/g, '""')}"` : "";
              
              const row = [
                `\t${item.date}`,
                escape(item.payer),
                escape(item.item),
                escape(item.sharedWith.join(" & ")), // 用 & 連接人名比較好看
                unitPrice // 這就是「單收金額」
              ];
              
              csvContent += row.join(",") + "\n";
            });

            // === 觸發下載 ===
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const fileName = `帳務匯出_${activeTab.value}_${getTodayDate()}.csv`;
            
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          onMounted(async () => {
            isInitializing.value = true;
            await fetchSettings();
            await fetchData();
          });

          return {
            items, payerList, memberList, categoryList, bankList,
            activeTab, personTabs, filteredItems, summary, 
            showModal, showBatchModal, isEditing, form, batchForm, batchList, batchTotal, 
            isInitializing, isLoading, isSaving, 
            toggleShared, togglePaidBy, 
            saveItem, saveBatch, openModal, openBatchModal, closeBatchModal, addBatchRow, removeBatchRow, 
            editItem, closeModal, deleteItem, formatNumber, calcMyPay, calcMyReceive, sortOrder, toggleSort,
            filterBank, bankFilterOptions,
            scrollContainer, startDrag, stopDrag, doDrag, exportToExcel, sheetList, currentSheet, changeSheet, createNewSheet
          };
        }
      }).mount("#app");
    </script>
  </body>
</html>


